<!doctype html>
<html manifest="nestifycss.appcache">
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<title>Nestify CSS</title>
	<meta name="description" content="Make all CSS rules nested by user defined selector">
	<meta name="author" content="Marchenko Alexandr">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">	
	<link rel="stylesheet" href="//current.bootstrapcdn.com/bootstrap-v204/css/bootstrap-combined.min.css">
    <link rel="stylesheet" href="//yandex.st/highlightjs/6.1/styles/github.min.css">
</head>
<body>
<div class="container" role="main" style="margin:1em auto">
	<h2>Nestify my css</h2>
	<form class="well">
		<!--[if IE]><label>CSS or URL...</label><![endif]-->
		<textarea class="span11" rows="5" type="text" id="css" placeholder="CSS or URL..." required></textarea>
		<!--[if IE]><label>Nest By...</label><![endif]-->
		<input class="span11" type="text" id="by" placeholder="Nest By..." required />
		<button type="submit" class="btn disabled">Submit</button> 
		<noscript><span class="badge badge-error">Turn on javascript please<span></noscript>
		<label class="checkbox inline" style="margin-left:2em;"><input type="checkbox" id="minify"> minify</label>
	</form>
</div>

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
<script src="//yandex.st/highlightjs/6.1/highlight.js"></script>
<script src="//yandex.st/highlightjs/6.1/languages/css.js"></script>
<script src="//www.senchalabs.org/cssbeautify/cssbeautify.js"></script>
<script src="nestifycss.js"></script>
<script>
	(function($){
		$('button').removeClass('disabled');
		$('<pre></pre>').hide().appendTo('.container');
		$('form').on('submit', function(e){
			e.preventDefault();

			var css = $.trim($('#css').val());
			var by = $.trim($('#by').val());
			var minify = $('#minify:checked').size() > 0;
			
			if(!!css.match(/^https?:\/\//i)) { // if user give us url to css file
				var cssUrl = css;
				var yqlUrl = 'http://query.yahooapis.com/v1/public/yql?q=' + encodeURIComponent('select * from html where url="' + cssUrl + '"') + '&format=json&callback=cbfunc';
				$.ajax({
					type: "GET",
					url: yqlUrl,
					contentType: "application/json; charset=utf-8",
					jsonpCallback: "cbfunc",
					dataType: "jsonp",
					success: function(data) {
						var d = data.query.results.body.p;
						$('#css').val(d);
						css = nestifybeautify(d, by, minify);
						$('pre:first').html(css).show();
					},
					error: function(xhr, textStatus, errorThrown) {
						alert('Can not download CSS\n' + textStatus);
					}
				});
			} else { // if user give us css
				css = nestifybeautify(css, by, minify);
				$('pre:first').html(css).show();
			}

			return false;
		});

		function nestifybeautify(css, by, minify) {
			minify = !!minify;
			var indent = minify ? '' : '    ';
			
			// here we callign our nestifycss func
			var css = nestifycss(css, by);
			
			// many thnx to http://www.senchalabs.org/cssbeautify/
			css = cssbeautify(css, {indent: indent});

			if(minify) css = css.replace(/[\r\n\n]+/gi, '').split(', ').join(',');
			
			// and to http://softwaremaniacs.org/soft/highlight/en/
			css = hljs.highlight('css', css).value;

			return css;
		}
	})(jQuery);
</script>
</body>
</html>
